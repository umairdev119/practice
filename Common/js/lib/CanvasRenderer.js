THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){e=e||{};var t,i,r,o,n,a,s,l,c,p,d,f,h,m,v,E,y,x,u,g=this,S=new THREE.Projector,R=void 0!==e.canvas?e.canvas:document.createElement("canvas"),w=R.width,T=R.height,M=Math.floor(w/2),C=Math.floor(T/2),H=0,b=0,L=w,B=T,P=1,z=R.getContext("2d",{alpha:!0===e.alpha}),W=new THREE.Color(0),j=!0===e.alpha?0:1,D=1,V=0,N=null,k=null,A=null,F=null,O=null,G=[],I=new THREE.Color,U=new THREE.Color,q=new THREE.Color,J=new THREE.Color,K={},Q=new THREE.Box2,X=new THREE.Box2,Y=new THREE.Box2,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee=new THREE.Vector3,te=new THREE.Vector3,ie=new THREE.Vector3,re=new THREE.Matrix3;function oe(e,t,i){fe(i.opacity),he(i.blending);var r=t.scale.x*M,o=t.scale.y*C,n=Math.sqrt(r*r+o*o);if(Y.min.set(e.x-n,e.y-n),Y.max.set(e.x+n,e.y+n),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=K[a.id];if(void 0!==s&&s.version===a.version||(s=ce(a),K[a.id]=s),void 0!==s.canvas){xe(s.canvas);var l=a.image,c=l.width*a.offset.x,p=l.height*a.offset.y,d=l.width*a.repeat.x,f=l.height*a.repeat.y,h=r/d,m=o/f;z.save(),z.translate(e.x,e.y),0!==i.rotation&&z.rotate(i.rotation),z.translate(-r/2,-o/2),z.scale(h,m),z.translate(-c,-p),z.fillRect(c,p,d,f),z.restore()}}else xe(i.color.getStyle()),z.save(),z.translate(e.x,e.y),0!==i.rotation&&z.rotate(i.rotation),z.scale(r,-o),z.fillRect(-.5,-.5,1,1),z.restore()}else i.isSpriteCanvasMaterial?(ye(i.color.getStyle()),xe(i.color.getStyle()),z.save(),z.translate(e.x,e.y),0!==i.rotation&&z.rotate(i.rotation),z.scale(r,o),i.program(z),z.restore()):i.isPointsMaterial&&(xe(i.color.getStyle()),z.save(),z.translate(e.x,e.y),0!==i.rotation&&z.rotate(i.rotation),z.scale(r*i.size,-o*i.size),z.fillRect(-.5,-.5,1,1),z.restore())}function ne(e,t,i,r){if(fe(r.opacity),he(r.blending),z.beginPath(),z.moveTo(e.positionScreen.x,e.positionScreen.y),z.lineTo(t.positionScreen.x,t.positionScreen.y),r.isLineBasicMaterial){if(me(r.linewidth),ve(r.linecap),Ee(r.linejoin),r.vertexColors!==THREE.VertexColors)ye(r.color.getStyle());else{var o=i.vertexColors[0].getStyle(),n=i.vertexColors[1].getStyle();if(o===n)ye(o);else{try{var a=z.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,n)}catch(e){a=o}ye(a)}}r.isLineDashedMaterial&&ue([r.dashSize,r.gapSize]),z.stroke(),Y.expandByScalar(2*r.linewidth),r.isLineDashedMaterial&&ue([])}}function ae(e,t,i,o,n,a,S,R){var w,T,M,C,H,b;if(g.info.render.vertices+=3,g.info.render.faces++,fe(R.opacity),he(R.blending),s=e.positionScreen.x,l=e.positionScreen.y,c=t.positionScreen.x,p=t.positionScreen.y,d=i.positionScreen.x,f=i.positionScreen.y,w=s,T=l,M=c,C=p,H=d,b=f,z.beginPath(),z.moveTo(w,T),z.lineTo(M,C),z.lineTo(H,b),z.closePath(),(R.isMeshLambertMaterial||R.isMeshPhongMaterial||R.isMeshStandardMaterial)&&null===R.map)U.copy(R.color),q.copy(R.emissive),R.vertexColors===THREE.FaceColors&&U.multiply(S.color),I.copy(Z),te.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),function(e,t,i){for(var o=0,n=r.length;o<n;o++){var a=r[o];if(J.copy(a.color),a.isDirectionalLight){var s=ee.setFromMatrixPosition(a.matrixWorld).normalize();if((l=t.dot(s))<=0)continue;l*=a.intensity,i.add(J.multiplyScalar(l))}else if(a.isPointLight){var l;if(s=ee.setFromMatrixPosition(a.matrixWorld),(l=t.dot(ee.subVectors(s,e).normalize()))<=0)continue;if(0==(l*=0==a.distance?1:1-Math.min(e.distanceTo(s)/a.distance,1)))continue;l*=a.intensity,i.add(J.multiplyScalar(l))}}}(te,S.normalModel,I),I.multiply(U).add(q),!0===R.wireframe?se(I,R.wireframeLinewidth,R.wireframeLinecap,R.wireframeLinejoin):le(I);else if(R.isMeshBasicMaterial||R.isMeshLambertMaterial||R.isMeshPhongMaterial||R.isMeshStandardMaterial){if(null!==R.map)R.map.mapping===THREE.UVMapping&&(h=S.uvs,pe(s,l,c,p,d,f,h[o].x,h[o].y,h[n].x,h[n].y,h[a].x,h[a].y,R.map));else null!==R.envMap?R.envMap.mapping===THREE.SphericalReflectionMapping&&(ie.copy(S.vertexNormalsModel[o]).applyMatrix3(re),m=.5*ie.x+.5,v=.5*ie.y+.5,ie.copy(S.vertexNormalsModel[n]).applyMatrix3(re),E=.5*ie.x+.5,y=.5*ie.y+.5,ie.copy(S.vertexNormalsModel[a]).applyMatrix3(re),x=.5*ie.x+.5,u=.5*ie.y+.5,pe(s,l,c,p,d,f,m,v,E,y,x,u,R.envMap)):(I.copy(R.color),R.vertexColors===THREE.FaceColors&&I.multiply(S.color),!0===R.wireframe?se(I,R.wireframeLinewidth,R.wireframeLinecap,R.wireframeLinejoin):le(I))}else R.isMeshNormalMaterial?(ie.copy(S.normalModel).applyMatrix3(re),I.setRGB(ie.x,ie.y,ie.z).multiplyScalar(.5).addScalar(.5),!0===R.wireframe?se(I,R.wireframeLinewidth,R.wireframeLinecap,R.wireframeLinejoin):le(I)):(I.setRGB(1,1,1),!0===R.wireframe?se(I,R.wireframeLinewidth,R.wireframeLinecap,R.wireframeLinejoin):le(I))}function se(e,t,i,r){me(t),ve(i),Ee(r),ye(e.getStyle()),z.stroke(),Y.expandByScalar(2*t)}function le(e){xe(e.getStyle()),z.fill()}function ce(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,o=e.wrapS===THREE.MirroredRepeatWrapping,n=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(o?2:1),a.height=t.height*(n?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0===o&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0===n&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0===o&&!0===n&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";!0===i&&!0===r?l="repeat":!0===i?l="repeat-x":!0===r&&(l="repeat-y");var c=z.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function pe(e,t,i,r,o,n,a,s,l,c,p,d,f){var h=K[f.id];if(void 0!==h&&h.version===f.version||(h=ce(f),K[f.id]=h),void 0===h.canvas)return xe("rgba( 0, 0, 0, 1)"),void z.fill();xe(h.canvas);var m,v,E,y,x,u,g,S,R=f.offset.x/f.repeat.x,w=f.offset.y/f.repeat.y,T=f.image.width*f.repeat.x,M=f.image.height*f.repeat.y;l=(l+R)*T,c=(c+w)*M,p=(p+R)*T,d=(d+w)*M,i-=e,r-=t,o-=e,n-=t,0!==(g=(l-=a=(a+R)*T)*(d-=s=(s+w)*M)-(p-=a)*(c-=s))&&(x=e-(m=(d*i-c*o)*(S=1/g))*a-(E=(l*o-p*i)*S)*s,u=t-(v=(d*r-c*n)*S)*a-(y=(l*n-p*r)*S)*s,z.save(),z.transform(m,v,E,y,x,u),z.fill(),z.restore())}function de(e,t,i){var r,o=t.x-e.x,n=t.y-e.y,a=o*o+n*n;0!==a&&(o*=r=i/Math.sqrt(a),n*=r,t.x+=o,t.y+=n,e.x-=o,e.y-=n)}function fe(e){D!==e&&(z.globalAlpha=e,D=e)}function he(e){V!==e&&(e===THREE.NormalBlending?z.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?z.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?z.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(z.globalCompositeOperation="multiply"),V=e)}function me(e){A!==e&&(z.lineWidth=e,A=e)}function ve(e){F!==e&&(z.lineCap=e,F=e)}function Ee(e){O!==e&&(z.lineJoin=e,O=e)}function ye(e){N!==e&&(z.strokeStyle=e,N=e)}function xe(e){k!==e&&(z.fillStyle=e,k=e)}function ue(e){G.length!==e.length&&(z.setLineDash(e),G=e)}void 0===z.setLineDash&&(z.setLineDash=function(){}),this.domElement=R,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.getContext=function(){return z},this.getContextAttributes=function(){return z.getContextAttributes()},this.getPixelRatio=function(){return P},this.setPixelRatio=function(e){void 0!==e&&(P=e)},this.setSize=function(e,t,i){w=e*P,T=t*P,R.width=w,R.height=T,M=Math.floor(w/2),C=Math.floor(T/2),!1!==i&&(R.style.width=e+"px",R.style.height=t+"px"),Q.min.set(-M,-C),Q.max.set(M,C),X.min.set(-M,-C),X.max.set(M,C),D=1,V=0,N=null,k=null,A=null,F=null,O=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,r){H=e*P,b=t*P,L=i*P,B=r*P},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){W.set(e),j=void 0!==t?t:1,X.min.set(-M,-C),X.max.set(M,C)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return W},this.getClearAlpha=function(){return j},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===X.isEmpty()&&(X.intersect(Q),X.expandByScalar(2),X.min.x=X.min.x+M,X.min.y=-X.min.y+C,X.max.x=X.max.x+M,X.max.y=-X.max.y+C,j<1&&z.clearRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0),j>0&&(fe(1),he(THREE.NormalBlending),xe("rgba("+Math.floor(255*W.r)+","+Math.floor(255*W.g)+","+Math.floor(255*W.b)+","+j+")"),z.fillRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0)),X.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,s){if(void 0!==s.isCamera){var l=e.background;l&&l.isColor?(fe(1),he(THREE.NormalBlending),xe(l.getStyle()),z.fillRect(0,0,w,T)):!0===this.autoClear&&this.clear(),g.info.render.vertices=0,g.info.render.faces=0,z.setTransform(L/w,0,0,-B/T,H,T-b),z.translate(M,C),t=S.projectScene(e,s,this.sortObjects,this.sortElements),i=t.elements,r=t.lights,re.getNormalMatrix(s.matrixWorldInverse),function(){Z.setRGB(0,0,0),$.setRGB(0,0,0),_.setRGB(0,0,0);for(var e=0,t=r.length;e<t;e++){var i=r[e],o=i.color;i.isAmbientLight?Z.add(o):i.isDirectionalLight?$.add(o):i.isPointLight&&_.add(o)}}();for(var c=0,p=i.length;c<p;c++){var d=i[c],f=d.material;if(void 0!==f&&0!==f.opacity){if(Y.makeEmpty(),d instanceof THREE.RenderableSprite)(o=d).x*=M,o.y*=C,oe(o,d,f);else if(d instanceof THREE.RenderableLine)o=d.v1,n=d.v2,o.positionScreen.x*=M,o.positionScreen.y*=C,n.positionScreen.x*=M,n.positionScreen.y*=C,Y.setFromPoints([o.positionScreen,n.positionScreen]),!0===Q.intersectsBox(Y)&&ne(o,n,d,f);else if(d instanceof THREE.RenderableFace){if(o=d.v1,n=d.v2,a=d.v3,o.positionScreen.z<-1||o.positionScreen.z>1)continue;if(n.positionScreen.z<-1||n.positionScreen.z>1)continue;if(a.positionScreen.z<-1||a.positionScreen.z>1)continue;o.positionScreen.x*=M,o.positionScreen.y*=C,n.positionScreen.x*=M,n.positionScreen.y*=C,a.positionScreen.x*=M,a.positionScreen.y*=C,f.overdraw>0&&(de(o.positionScreen,n.positionScreen,f.overdraw),de(n.positionScreen,a.positionScreen,f.overdraw),de(a.positionScreen,o.positionScreen,f.overdraw)),Y.setFromPoints([o.positionScreen,n.positionScreen,a.positionScreen]),!0===Q.intersectsBox(Y)&&ae(o,n,a,0,1,2,d,f)}X.union(Y)}}z.setTransform(1,0,0,1,0,0)}}};